# SVM Train and Evaluation

Ноутбук с обучением детекции и классификации людей SVM на выбранном датасете.

**Пайплайн обучения**
- Предобработка изображений
- Выгрузка признаков изображений из предобученной Resnet
- Обучение на полученных признаках классификации SVM

**Инференс**
- Выбор регионов интереса в тестовых изображениях с помощью KMeans
- Предобработка выбранных регионов
- Выгрузка признаков изображений из предобученной Resnet
- Получение классов (1 человек, 0 фон) и вероятностей принадлежности к ним для поданных в обученную модель регионов

**Оценка качества**
- Подсчет Intersection over Union для предсказанных и реальных bboxes целевого класса
- Подсчет IoU для среднего бибокса, полученного на центре изображения

## Обучение

### Предобработка изображений

Рассчитали средний размер bbox-а целевого класса, вырезали по нему все патчи целевого класса person на обучающем датасете. Также вырезали рандомный бекграунд без людей аналогичного размера, чтобы иметь класс 0. 

Для подачи изображений в обученную Resnet нужно привести их к нужному формату – 224 x 224. Наш датасет — это преимущественно вид сверху с большого масштаба. Средний размер целевого класса 16 x 30. Тк. в задаче детекции людей пропорции играют ключевую роль, просто растягивать изображения не стоит. Добавили паддинг, чтобы достичь нужного размера для весов Resnet.

### Обучение SVM 

Подали полученные из Resnet векторы в SMV, обучили модель и замерили качество классическими метриками классификации (F1 Score), чтобы просто убедиться, что с моделью можно идти дальше в оценку качества на тестовой выборке.

## Инференс

Изначально хотели реализовать 3 подхода и сравнить качество каждого:
- Скользящее окно
- Выбор регионов интереса при помощи кластеризации KMeans
- Selective Search

Из-за специфики датасета (целевой класс очень маленький относительно всего изображения) нам не подходит скользящее окно — для среднего размера бибокса 16 x 30 прохождение окном даже по одному изображению (1500 x 990) будет занимать много времени и памяти и станет невозможным в поддержке на масштабе.

Selective Search также показал себя как достачно медленный метод, поэтому сосредоточимся на поиске регионов интереса KMeans.

Мы знаем распределение размеров бибоксов целевого класса, поэтому сразу смогли задать ограничения по площади для выбора регионов. Тк. превалирующий класс в датасете – авто, и их кластеризация по умолчанию детектировала лучше всего, ограничение площади региона сверху стало необходимым условием для определения хоть сколько то приемлемых участков для обработки. 

Также провели эксперименты с размытием (GaussianBlur) и повышением контрастности. Изначально на изображениях много объектов и шума, поэтому повышение контрастности сделало только хуже. Остановились на обработке с помощью GaussianBlur. 

Так как бОльщая часть людей располагается в цетральной части всех изображений, выкидываем регионы на 10% края фото.

Такой набор ограничений и обработки помог добиться приемлемого выбора регионов для нашей задачи.

Остальные шаги по предобработке повторяют действия обучающей выборки. 
Подали предобработанные регионы в обученную SMV модель, получили классы и вероятность принадлежности к ним.


## Оценка качества

Выбрали метрику Intersection over Union (IoU) — метрика совпадения между двумя прямоугольными областями. Используется в задачах детекции объектов.
Сравнивали IoU для предсказанных бибоксов целевого класса (вероятность принадлжености 0.85)и реальных бибоксов целевого класса. С IoU среднего бибокса, вырезанного из центра изображения, с реальными.

Полученные результаты для инференса:
- Среднее значение IoU: 0.1402
- Точность предсказаний при пороге 0.5: 0.1212

Для среднего центрального бибокса:
- Среднее значение IoU для центрального бокса: 0.0006
- Точность при пороге 0.5: 0.0001

Полученные результаты выше рандомных, но характеризуются как слабое перекрытие предсказанных боксов с реальными. В общем эта метрика не удовлетворительна. Что говорит о низком качестве обученной модели.

### Что можно улучшить?

При просмотре результатов предсказания стало понятно, куда двигаться дальше.
- В обучение было подано слишком мало объектов нецелевого класса (20%), так как люди занимают очень маленькую площадь от изображения, нужно было делать выборку более сбалансированной.
- У нас есть бибоксы не только для целевого класса, но и для других объектов на фото (авто, траки, байки). Транспорт легче и чаще детектируется кластеризацией, чем люди. Поэтому очень важно также подавать его в обучение, тк. модель точно столкнется с ним  на инференсе.
- Попробовать целенаправлено генерировать в обучающую выборку участки фона, в которых часто ошибается модель – контрастная трава и деревья, окна домов, какие-то яркие атрибуты вдоль дорог (баннеры, вывески). Это должно помочь обучить модель какие из часто выделяемых классификацией классов точно не являются целевыми.

Также показалось, что эксперименты с извлечением регионов интереса KMeans достаточно мощный инструмент, возможно получится добиться повышения качества уже на этапе отбора регионов, поработав с ним. 
